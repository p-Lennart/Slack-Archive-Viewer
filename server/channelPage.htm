<!DOCTYPE html>
<html>
    <head>
        <script src = 'urlParameters.js'></script>
        <script>
            function setTitle(str) {
                document.title = `Slack | ${str}`;
            }
        
            function setDisplay(ID, value) {
                document.getElementById(ID).style.display = value;
            }

            function toggleCollapse(t) {
                let contentID = t.id.split('Title').join('Content');
                let titleMaxID = t.id + 'Max';
                let titleMinID = t.id + 'Min';

                if (document.getElementById(contentID).style.display === 'none') {
                    setDisplay(contentID, 'block');
                    setDisplay(titleMaxID, 'block');
                    setDisplay(titleMinID, 'none');
                } else {
                    setDisplay(contentID, 'none');
                    setDisplay(titleMaxID, 'none');
                    setDisplay(titleMinID, 'block');
                }
            }
        </script>
        <script async type = "module">
            import { jml, jml_nester } from './jml.mjs';
            import { loadData } from './loadData.mjs';
            import { formatSlackDateFromTs } from './timestamps.mjs'
            import { formatUsernameFromId } from './users.mjs';

            import { applyWidgetJml } from './widgetJml.mjs';
            import { membersWidgetJml } from './membersWidget.mjs';
            import { channelEntriesWidgetJml } from './channelEntriesWidget.mjs';
            
            let params = getURLParameters();
            if (!params.id) {
                throw new Error('Missing parameter "id"'); 
            }
            
            const ARCHIVE_DATA = await loadData('./VIEWERDATA', 'VIEWERDATA_map.json'); 
            
            const channelData = ARCHIVE_DATA.CHANNELS_ARR.find((c) => c.id === params.id);
            const channelName = channelData.name;
            const channelMap = ARCHIVE_DATA.ARCHIVE_MAP[channelName];

            let channelPath = `./VIEWERDATA/${ARCHIVE_DATA.ARCHIVE_NAME}/${channelName}`;
            console.log(channelPath);

            init(channelPath);

            async function init(dir) {
                setTitle('#' + channelName);
                document.querySelector('#channelTitle').innerHTML = '#' + channelName;
                document.querySelector('#channelTopic').innerHTML = channelData.topic.value.replace('\n', '<br>');;
                document.querySelector('#channelPurpose').innerHTML = channelData.purpose.value.replace('\n', '<br>');    

                document.querySelector('#channelStats').innerHTML += 'Created: ' + formatSlackDateFromTs(channelData.created);
                document.querySelector('#channelStats').innerHTML += '<br>Creator: ' + formatUsernameFromId(ARCHIVE_DATA.USERS_ARR, channelData.creator);
                document.querySelector('#channelStats').innerHTML += '<br>Archived: ' + channelData.is_archived;
                
                applyWidgetJml('#members', membersWidgetJml, ARCHIVE_DATA, channelData.members);
                applyWidgetJml('#channelEntries', channelEntriesWidgetJml, ARCHIVE_DATA, channelName);
            }

        </script>
        <link rel="stylesheet" href="main.css">
        <link rel="stylesheet" href="memberPane.css">
    </head>
    <body>
        <div id='members'></div>
        <h1 id='channelTitle'></h1>
        <h2 id='channelTopic'></h2>
        <div id='channelPurpose'></div>
        <div id='channelStats'></div>
        <div id='channelEntries'></div>
    </body>
</html>