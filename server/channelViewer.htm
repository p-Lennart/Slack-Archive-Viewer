<!DOCTYPE html>
<html>
    <head>
        <script src = 'urlParameters.js'></script>
        <script>
            function setTitle(str) {
                document.title = `Slack | ${str}`;
            }
        
            function setDisplay(ID, value) {
                document.getElementById(ID).style.display = value;
            }

            function toggleCollapse(t) {
                let contentID = t.id.split('Title').join('Content');
                let titleMaxID = t.id + 'Max';
                let titleMinID = t.id + 'Min';

                if (document.getElementById(contentID).style.display === 'none') {
                    setDisplay(contentID, 'block');
                    setDisplay(titleMaxID, 'block');
                    setDisplay(titleMinID, 'none');
                } else {
                    setDisplay(contentID, 'none');
                    setDisplay(titleMaxID, 'none');
                    setDisplay(titleMinID, 'block');
                }
            }
        </script>
        <script async type = "module">
            import { jml, jml_nester } from './jml.mjs';
            import { loadData, getChannelPath, getChannelMessages } from './loadData.mjs';
            import { applyWidgetJml } from './widgetJml.mjs';
            import { usersWidgetJml } from './usersWidget.mjs';
            import { channelMessagesJml } from './channelMessages.mjs';

            let params = getURLParameters();
            
            if (!params.id) {
                throw new Error('Missing parameter "id"'); 
            }
            if (!params.date) {
                throw new Error('Missing parameter "date"'); 
            }

            const ARCHIVE_DATA = await loadData(); 
            
            const channelData = ARCHIVE_DATA.CHANNELS_ARR.find((c) => c.id === params.id);
            const channelName = channelData.name;
            const channelMap = ARCHIVE_DATA.ARCHIVE_MAP[channelName];

            const messages = await getChannelMessages(ARCHIVE_DATA, channelName, params.date);

            init(getChannelPath(ARCHIVE_DATA, channelName), params.date)

            async function init(path, date) {
                setTitle('#' + channelName);

                document.querySelector('#channelTitle').innerHTML = '#' + channelName;
                document.querySelector('#channelTopic').innerHTML = channelData.topic.value.replace('\n', '<br>');;
                document.querySelector('#channelPurpose').innerHTML = channelData.purpose.value.replace('\n', '<br>');    

                applyWidgetJml('#members', usersWidgetJml, ARCHIVE_DATA, channelData.users);
                applyWidgetJml('#messages', channelMessagesJml, ARCHIVE_DATA, messages);
            }

        </script>
        <link rel="stylesheet" href="main.css">
        <link rel="stylesheet" href="memberPane.css">
    </head>
    <body>
        <div id='members'></div>
        <h1 id='channelTitle'></h1>
        <h2 id='channelTopic'></h2>
        <h3 id='channelPurpose'></h3>
        <div class='container'>
            <table id='messages'></table>
        </div>
    </body>
</html>